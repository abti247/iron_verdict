<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JudgeMe - Powerlifting Judging</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        :root {
            /* Primary Colors */
            --bg-primary: #0f1419;
            --bg-surface: #1a202c;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --accent-gold: #d4af37;

            /* Status Colors */
            --status-success: #48bb78;
            --status-pending: #d4af37;
            --status-error: #f56565;

            /* Vote Colors (IPF Standard) */
            --vote-white: #ffffff;
            --vote-red: #ff4444;
            --vote-blue: #4444ff;
            --vote-yellow: #ffff44;

            /* Spacing */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 40px;

            /* Transitions */
            --transition-fast: 200ms ease-in-out;
            --transition-normal: 300ms ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
        }

        main {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Button Base */
        button {
            padding: var(--spacing-lg) var(--spacing-md);
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Primary Button (Gold) */
        .btn-primary {
            background-color: var(--accent-gold);
            color: var(--bg-primary);
            font-weight: bold;
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            transform: translateY(-2px);
        }

        .btn-primary:active:not(:disabled) {
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }

        /* Secondary Button (Charcoal with Gold Border) */
        .btn-secondary {
            background-color: var(--bg-surface);
            color: var(--text-primary);
            border: 2px solid var(--accent-gold);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--accent-gold);
            color: var(--bg-primary);
        }

        .btn-secondary:active:not(:disabled) {
            box-shadow: inset 0 0 15px rgba(212, 175, 55, 0.4);
        }

        /* Danger Button (Red) */
        .btn-danger {
            background-color: var(--status-error);
            color: var(--text-primary);
            font-weight: bold;
        }

        .btn-danger:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(245, 101, 101, 0.6);
            transform: translateY(-2px);
        }

        .btn-danger:active:not(:disabled) {
            border: 2px solid var(--status-error);
            box-shadow: 0 0 30px rgba(245, 101, 101, 0.8);
        }

        /* Full Width Button */
        .btn-full {
            width: 100%;
        }

        /* Button Grid */
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        @media (max-width: 600px) {
            .btn-grid {
                gap: var(--spacing-sm);
            }

            button {
                min-height: 44px;
                padding: var(--spacing-md) var(--spacing-sm);
            }
        }

        /* TASK 3: Input Fields */
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: var(--spacing-md);
            font-size: 16px;
            background-color: var(--bg-surface);
            color: var(--text-primary);
            border: 2px solid transparent;
            border-radius: 8px;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
            margin-bottom: var(--spacing-md);
        }

        input[type="text"]::placeholder,
        input[type="password"]::placeholder {
            color: var(--text-secondary);
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        /* TASK 3: Card Component */
        .card {
            background-color: var(--bg-surface);
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border: 1px solid rgba(212, 175, 55, 0.1);
            transition: all var(--transition-normal);
        }

        .card:hover {
            border-color: var(--accent-gold);
        }

        .card-sm {
            padding: var(--spacing-md);
        }

        .card-lg {
            padding: var(--spacing-2xl);
        }

        /* TASK 3: Vote Button Cards */
        .vote-card {
            background-color: var(--bg-surface);
            border-radius: 8px;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            min-width: 100px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all var(--transition-fast);
        }

        .vote-card:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .vote-card.selected {
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .vote-card button {
            width: 100%;
            height: 100%;
            min-height: 100px;
        }

        /* TASK 3: Divider */
        .divider {
            height: 2px;
            background-color: var(--accent-gold);
            margin: var(--spacing-lg) 0;
            opacity: 0.3;
        }

        /* TASK 3: Status Message */
        .status-msg {
            padding: var(--spacing-md);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin: var(--spacing-md) 0;
        }

        .status-success {
            background-color: rgba(72, 187, 120, 0.15);
            color: var(--status-success);
            border: 1px solid var(--status-success);
        }

        .status-error {
            background-color: rgba(245, 101, 101, 0.15);
            color: var(--status-error);
            border: 1px solid var(--status-error);
        }

        .status-pending {
            background-color: rgba(212, 175, 55, 0.15);
            color: var(--accent-gold);
            border: 1px solid var(--accent-gold);
        }

        /* TASK 4: Containers */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: var(--spacing-md);
            width: 100%;
        }

        .container-lg {
            max-width: 1000px;
        }

        .container-full {
            max-width: 100%;
            padding: 0;
        }

        /* TASK 4: Flex & Grid Utilities */
        .flex {
            display: flex;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gap-sm {
            gap: var(--spacing-sm);
        }

        .gap-md {
            gap: var(--spacing-md);
        }

        .gap-lg {
            gap: var(--spacing-lg);
        }

        /* TASK 4: Spacing Utilities */
        .mt-md { margin-top: var(--spacing-md); }
        .mt-lg { margin-top: var(--spacing-lg); }
        .mt-xl { margin-top: var(--spacing-xl); }
        .mb-md { margin-bottom: var(--spacing-md); }
        .mb-lg { margin-bottom: var(--spacing-lg); }
        .mb-xl { margin-bottom: var(--spacing-xl); }
        .p-md { padding: var(--spacing-md); }
        .p-lg { padding: var(--spacing-lg); }

        /* TASK 4: Text Utilities */
        .text-center {
            text-align: center;
        }

        .text-uppercase {
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .text-gold {
            color: var(--accent-gold);
        }

        .text-lg {
            font-size: 18px;
        }

        .text-xl {
            font-size: 24px;
        }

        .text-2xl {
            font-size: 32px;
        }

        .text-3xl {
            font-size: 48px;
        }

        .text-4xl {
            font-size: 64px;
        }

        .text-5xl {
            font-size: 120px;
        }

        /* TASK 4: Header Bar */
        .header-bar {
            background-color: var(--bg-surface);
            padding: var(--spacing-md);
            border-bottom: 2px solid var(--accent-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-info {
            display: flex;
            gap: var(--spacing-lg);
            align-items: center;
            flex-wrap: wrap;
        }

        .header-info strong {
            color: var(--accent-gold);
        }

        .session-code {
            cursor: pointer;
            text-decoration: underline;
            transition: color var(--transition-fast);
        }

        .session-code:hover {
            color: var(--accent-gold);
        }

        /* TASK 5: Typography */
        h1, h2, h3 {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-md);
        }

        h1 {
            font-size: 48px;
            line-height: 1.2;
        }

        h2 {
            font-size: 32px;
            line-height: 1.3;
        }

        h3 {
            font-size: 24px;
            line-height: 1.4;
        }

        p {
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
            line-height: 1.8;
        }

        /* TASK 5: Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0a0e13 100%);
            padding: var(--spacing-2xl) var(--spacing-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="rgba(212,175,55,0.05)"/><stop offset="1" stop-color="rgba(212,175,55,0)"/></linearGradient></defs><line x1="50" y1="50" x2="50" y2="150" stroke="url(%23g)" stroke-width="4"/><circle cx="50" cy="50" r="15" stroke="url(%23g)" stroke-width="2" fill="none"/><circle cx="50" cy="150" r="15" stroke="url(%23g)" stroke-width="2" fill="none"/></svg>') center/cover;
            opacity: 0.3;
            pointer-events: none;
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 600px;
        }

        .hero h1 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .hero h1 .gold {
            color: var(--accent-gold);
        }

        .hero-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        .hero-value-prop {
            list-style: none;
            margin: var(--spacing-xl) 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .hero-value-prop li {
            padding: var(--spacing-md);
            background-color: rgba(212, 175, 55, 0.05);
            border-left: 3px solid var(--accent-gold);
            text-align: left;
            color: var(--text-secondary);
        }

        .hero-cta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 32px;
            }

            h2 {
                font-size: 24px;
            }

            .hero {
                min-height: 300px;
                padding: var(--spacing-xl) var(--spacing-md);
            }

            .hero-cta {
                grid-template-columns: 1fr;
            }
        }

        /* Judge Interface */
        .judge-screen {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--bg-primary);
        }

        .judge-content {
            flex: 1;
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
        }

        .voting-area {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            flex: 1;
            justify-content: center;
        }

        .vote-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) auto;
            width: 100%;
            max-width: 400px;
        }

        .vote-btn-white {
            background-color: var(--vote-white);
            color: var(--bg-primary);
            font-weight: bold;
        }

        .vote-btn-white:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .vote-btn-white.selected {
            border: 3px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }

        .vote-btn-red {
            background-color: var(--vote-red);
            color: var(--text-primary);
            font-weight: bold;
        }

        .vote-btn-red:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }

        .vote-btn-red.selected {
            border: 3px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }

        .vote-btn-blue {
            background-color: var(--vote-blue);
            color: var(--text-primary);
            font-weight: bold;
        }

        .vote-btn-blue:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(68, 68, 255, 0.6);
        }

        .vote-btn-blue.selected {
            border: 3px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }

        .vote-btn-yellow {
            background-color: var(--vote-yellow);
            color: var(--bg-primary);
            font-weight: bold;
        }

        .vote-btn-yellow:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(255, 255, 68, 0.6);
        }

        .vote-btn-yellow.selected {
            border: 3px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
        }

        .lock-in-section {
            text-align: center;
            margin: var(--spacing-lg) 0;
        }

        .head-judge-section {
            border-top: 2px solid var(--accent-gold);
            padding-top: var(--spacing-lg);
            margin-top: var(--spacing-2xl);
        }

        .head-judge-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        @media (max-width: 600px) {
            .judge-content {
                padding: var(--spacing-md);
            }

            .vote-buttons {
                gap: var(--spacing-md);
            }

            .head-judge-controls {
                gap: var(--spacing-sm);
            }
        }

        /* Display Screen */
        .display-screen {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--bg-primary);
        }

        .display-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-2xl);
            text-align: center;
        }

        .display-timer {
            font-size: var(--text-5xl);
            font-weight: bold;
            margin-bottom: var(--spacing-2xl);
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .display-timer.expired {
            color: var(--status-error);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .judge-lights {
            display: flex;
            justify-content: center;
            gap: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            flex-wrap: nowrap;
        }

        .judge-light {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 4px solid rgba(212, 175, 55, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: var(--bg-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all var(--transition-normal);
            background-color: #f5f5f5;
        }

        .judge-light.light-white {
            background-color: var(--vote-white);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
        }

        .judge-light.light-red {
            background-color: var(--vote-red);
            color: white;
            box-shadow: 0 0 40px rgba(255, 68, 68, 0.8);
        }

        .judge-light.light-blue {
            background-color: var(--vote-blue);
            color: white;
            box-shadow: 0 0 40px rgba(68, 68, 255, 0.8);
        }

        .judge-light.light-yellow {
            background-color: var(--vote-yellow);
            box-shadow: 0 0 40px rgba(255, 255, 68, 0.8);
        }

        .display-status {
            font-size: var(--text-xl);
            color: var(--accent-gold);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media (max-width: 1200px) {
            .judge-light {
                width: 150px;
                height: 150px;
            }
        }

        @media (max-width: 768px) {
            .judge-light {
                width: 120px;
                height: 120px;
                font-size: 12px;
            }

            .judge-lights {
                gap: var(--spacing-lg);
            }

            .display-timer {
                font-size: 80px;
                margin-bottom: var(--spacing-lg);
            }
        }

        @media (max-width: 600px) {
            .judge-light {
                width: 100px;
                height: 100px;
                font-size: 10px;
            }

            .judge-lights {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .display-timer {
                font-size: 64px;
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-sm);
            }

            .header-bar {
                flex-wrap: wrap;
                padding: var(--spacing-sm);
            }

            .header-info {
                width: 100%;
                gap: var(--spacing-md);
            }

            button {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 28px;
            }

            h2 {
                font-size: 20px;
            }

            .hero {
                min-height: 250px;
                padding: var(--spacing-lg) var(--spacing-sm);
            }

            .hero h1 {
                font-size: 28px;
            }

            button {
                min-height: 40px;
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 14px;
            }

            .text-3xl {
                font-size: 32px;
            }

            .text-2xl {
                font-size: 24px;
            }
        }

        /* Landscape Mode */
        @media (max-height: 600px) and (orientation: landscape) {
            .hero {
                min-height: auto;
                padding: var(--spacing-lg) var(--spacing-md);
            }

            .judge-content {
                padding: var(--spacing-md);
            }

            .display-content {
                padding: var(--spacing-lg);
            }
        }

        /* Touch-friendly adjustments */
        @media (hover: none) {
            button:active:not(:disabled) {
                opacity: 0.8;
            }
        }

        /* Dark mode detection */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--bg-primary);
                color: var(--text-primary);
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Accessibility */
        button:focus,
        input:focus {
            outline: 2px solid var(--accent-gold);
            outline-offset: 2px;
        }

        /* High contrast mode */
        @media (prefers-contrast: more) {
            .btn-primary {
                border: 2px solid var(--text-primary);
            }

            .btn-secondary {
                border: 2px solid var(--text-primary);
            }
        }
    </style>
</head>
<body>
    <div class="container" x-data="judgemeApp()" x-init="init()">
        <h1>JudgeMe</h1>

        <!-- Landing screen -->
        <div x-show="screen === 'landing'" class="container-full">
            <div class="hero">
                <div class="hero-content">
                    <h1>JUDGE<span class="gold">ME</span></h1>
                    <p class="hero-subtitle">Professional Powerlifting Competition Judging</p>

                    <ul class="hero-value-prop">
                        <li>Real-time judging for sanctioned competitions</li>
                        <li>Three independent judges, instant results</li>
                        <li>No accounts. No setup. Just a 6-character code.</li>
                    </ul>

                    <div class="hero-cta">
                        <button class="btn-primary btn-full" @click="createSession()">
                            Create Session
                        </button>
                        <button class="btn-secondary btn-full" @click="screen = 'role-select'">
                            Join Session
                        </button>
                    </div>

                    <div style="margin-top: var(--spacing-xl); border-top: 1px solid rgba(212, 175, 55, 0.2); padding-top: var(--spacing-lg);">
                        <p class="text-secondary" style="font-size: 14px; margin-bottom: var(--spacing-md);">Enter session code to join an existing competition:</p>
                        <input type="text" x-model="joinCode" placeholder="Enter 6-character session code" style="margin-bottom: var(--spacing-md);">
                        <button class="btn-secondary btn-full" @click="screen = 'role-select'" :disabled="joinCode.length === 0">
                            Join with Code
                        </button>
                    </div>

                    <button class="btn-secondary btn-full mt-xl" @click="startDemo()" style="background: rgba(23, 162, 184, 0.2); border-color: #17a2b8;">
                        Try Demo Mode
                    </button>
                </div>
            </div>

            <div style="background-color: var(--bg-surface); padding: var(--spacing-xl); text-align: center; color: var(--text-secondary); font-size: 14px;">
                <p><strong style="color: var(--accent-gold);">Built for IPF-standard competitions</strong></p>
                <p style="margin-top: var(--spacing-sm);">No database. Sessions expire after 4 hours of inactivity.</p>
            </div>
        </div>

        <!-- Role selection screen -->
        <div x-show="screen === 'role-select'" class="container">
            <div class="card card-lg mt-xl">
                <h2 class="text-center mb-lg">Select Your Role</h2>
                <p class="text-center text-secondary mb-xl">Session: <span class="text-gold text-xl" style="cursor: pointer;" @click="screen = 'landing'">{{ sessionCode || joinCode }}</span></p>

                <div class="btn-grid">
                    <button class="btn-primary" @click="joinSession('left_judge')">
                        Left Judge
                    </button>
                    <button class="btn-primary" @click="joinSession('center_judge')">
                        Center Judge
                    </button>
                    <button class="btn-primary" @click="joinSession('right_judge')">
                        Right Judge
                    </button>
                    <button class="btn-secondary" @click="joinSession('display')">
                        Display
                    </button>
                </div>

                <button class="btn-secondary btn-full mt-lg" @click="screen = 'landing'">
                    Back to Landing
                </button>
            </div>
        </div>

        <!-- Judge screen -->
        <div x-show="screen === 'judge'" class="judge-screen">
            <div class="header-bar">
                <div class="header-info">
                    <div>
                        <strong>Session:</strong>
                        <span class="session-code" @click="returnToRoleSelection()" :title="'Click to return'" x-text="sessionCode"></span>
                    </div>
                </div>
                <div class="text-3xl" :style="timerExpired ? 'color: var(--status-error);' : 'color: var(--accent-gold);'" x-text="timerDisplay"></div>
            </div>

            <div class="judge-content">
                <div class="voting-area">
                    <h2 class="text-center mb-lg">Make Your Call</h2>

                    <div class="vote-buttons">
                        <button
                            @click="selectVote('white')"
                            :disabled="voteLocked"
                            :class="['btn-primary', 'vote-btn-white', { selected: selectedVote === 'white' }]">
                            White
                        </button>
                        <button
                            @click="selectVote('red')"
                            :disabled="voteLocked"
                            :class="['btn-primary', 'vote-btn-red', { selected: selectedVote === 'red' }]">
                            Red
                        </button>
                        <button
                            @click="selectVote('blue')"
                            :disabled="voteLocked"
                            :class="['btn-primary', 'vote-btn-blue', { selected: selectedVote === 'blue' }]">
                            Blue
                        </button>
                        <button
                            @click="selectVote('yellow')"
                            :disabled="voteLocked"
                            :class="['btn-primary', 'vote-btn-yellow', { selected: selectedVote === 'yellow' }]">
                            Yellow
                        </button>
                    </div>

                    <div class="lock-in-section" x-show="selectedVote && !voteLocked">
                        <button @click="lockVote()" class="btn-primary btn-full">
                            Lock In
                        </button>
                    </div>

                    <div x-show="voteLocked" class="card card-sm status-success text-center">
                        <strong>Your Vote:</strong> <span style="text-transform: uppercase;" x-text="selectedVote"></span>
                        <br>
                        <span style="font-size: 12px; opacity: 0.8;">(Locked)</span>
                    </div>
                </div>

                <!-- Head judge controls -->
                <div x-show="isHead" class="head-judge-section">
                    <h3>Head Judge Controls</h3>
                    <div class="head-judge-controls">
                        <button @click="startTimer()" class="btn-primary">Start Timer</button>
                        <button @click="resetTimer()" class="btn-secondary">Reset Timer</button>
                        <button @click="nextLift()" class="btn-secondary">Next Lift</button>
                        <button @click="confirmEndSession()" class="btn-danger">End Session</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display screen -->
        <div x-show="screen === 'display'" class="display-screen">
            <div class="header-bar">
                <div class="header-info">
                    <div>
                        <strong>Session:</strong>
                        <span class="session-code" @click="returnToRoleSelection()" :title="'Click to return'" x-text="sessionCode"></span>
                    </div>
                </div>
            </div>

            <div class="display-content">
                <div class="display-timer" :class="{ expired: timerExpired }" x-text="timerDisplay"></div>

                <div class="judge-lights">
                    <!-- Left Judge -->
                    <div class="judge-light" :class="displayVotes.left ? `light-${displayVotes.left}` : ''">
                        <span>Left</span>
                    </div>

                    <!-- Center Judge -->
                    <div class="judge-light" :class="displayVotes.center ? `light-${displayVotes.center}` : ''">
                        <span>Center</span>
                    </div>

                    <!-- Right Judge -->
                    <div class="judge-light" :class="displayVotes.right ? `light-${displayVotes.right}` : ''">
                        <span>Right</span>
                    </div>
                </div>

                <div class="display-status" x-text="displayStatus"></div>
            </div>
        </div>
    </div>

    <script>
        function judgemeApp() {
            return {
                screen: 'landing',
                sessionCode: '',
                joinCode: '',
                role: '',
                isHead: false,
                ws: null,
                selectedVote: null,
                voteLocked: false,
                resultsShown: false,
                timerDisplay: '60',
                timerExpired: false,
                timerInterval: null,
                displayVotes: { left: null, center: null, right: null },
                displayStatus: 'Waiting for judges...',
                intentionalNavigation: false,

                async createSession() {
                    try {
                        const response = await fetch('/api/sessions', { method: 'POST' });
                        if (!response.ok) {
                            alert('Failed to create session. Please try again.');
                            return;
                        }
                        const data = await response.json();
                        this.sessionCode = data.session_code;
                        this.screen = 'role-select';
                    } catch (error) {
                        alert('Error creating session. Please check your connection.');
                        console.error('Session creation error:', error);
                    }
                },

                joinSession(role) {
                    this.role = role;
                    const code = this.sessionCode || this.joinCode;
                    this.sessionCode = code;

                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

                    this.ws.onopen = () => {
                        this.ws.send(JSON.stringify({
                            type: 'join',
                            session_code: code,
                            role: role
                        }));
                    };

                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        alert('Connection error. Please check your network and try again.');
                    };

                    this.ws.onclose = (event) => {
                        if (!event.wasClean && !this.intentionalNavigation) {
                            console.error('WebSocket closed unexpectedly:', event);
                            alert('Connection lost. Please refresh and try again.');
                        }
                    };
                },

                handleMessage(message) {
                    if (message.type === 'join_success') {
                        this.isHead = message.is_head;
                        this.screen = this.role === 'display' ? 'display' : 'judge';
                    } else if (message.type === 'join_error') {
                        const sanitizedMessage = document.createTextNode(message.message).textContent;
                        alert(`Failed to join session: ${sanitizedMessage}`);
                    } else if (message.type === 'error') {
                        const sanitizedMessage = document.createTextNode(message.message).textContent;
                        alert(`Error: ${sanitizedMessage}`);
                    } else if (message.type === 'show_results') {
                        this.resultsShown = true;
                        if (this.role === 'display') {
                            this.displayVotes = message.votes;
                            this.displayStatus = 'Results shown';
                        }
                    } else if (message.type === 'reset_for_next_lift') {
                        this.resetVoting();
                        this.stopTimer();
                        if (this.role === 'display') {
                            this.displayVotes = { left: null, center: null, right: null };
                            this.displayStatus = 'Waiting for judges...';
                        }
                    } else if (message.type === 'timer_start') {
                        this.startTimerCountdown(message.server_timestamp);
                    } else if (message.type === 'timer_reset') {
                        this.stopTimer();
                    } else if (message.type === 'session_ended') {
                        alert('Session ended');
                        this.ws.close();
                        this.screen = 'landing';
                    }
                },

                selectVote(color) {
                    if (!this.voteLocked) {
                        this.selectedVote = color;
                    }
                },

                lockVote() {
                    if (this.selectedVote && !this.voteLocked) {
                        this.voteLocked = true;
                        this.ws.send(JSON.stringify({
                            type: 'vote_lock',
                            color: this.selectedVote
                        }));
                    }
                },

                resetVoting() {
                    this.selectedVote = null;
                    this.voteLocked = false;
                    this.resultsShown = false;
                },

                startTimer() {
                    this.ws.send(JSON.stringify({ type: 'timer_start' }));
                },

                resetTimer() {
                    this.ws.send(JSON.stringify({ type: 'timer_reset' }));
                },

                startTimerCountdown(serverTimestamp) {
                    this.stopTimer();
                    const startTime = serverTimestamp * 1000;
                    const duration = 60000; // 60 seconds

                    this.timerInterval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        const remaining = Math.max(0, duration - elapsed);
                        const seconds = Math.ceil(remaining / 1000);
                        this.timerDisplay = seconds;
                        this.timerExpired = seconds === 0;

                        if (seconds === 0) {
                            clearInterval(this.timerInterval);
                        }
                    }, 100);
                },

                stopTimer() {
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                    }
                    this.timerDisplay = '60';
                    this.timerExpired = false;
                },

                nextLift() {
                    this.ws.send(JSON.stringify({ type: 'next_lift' }));
                },

                confirmEndSession() {
                    if (confirm('Are you sure? This will disconnect all judges and the display')) {
                        this.ws.send(JSON.stringify({ type: 'end_session_confirmed' }));
                    }
                },

                getVoteColor(vote) {
                    const colors = {
                        white: 'white',
                        red: '#ff4444',
                        blue: '#4444ff',
                        yellow: '#ffff44'
                    };
                    return colors[vote] || '#f0f0f0';
                },

                returnToRoleSelection() {
                    this.intentionalNavigation = true;
                    if (this.ws) {
                        this.ws.close();
                    }
                    this.screen = 'role-select';
                    this.selectedVote = null;
                    this.voteLocked = false;
                    this.resultsShown = false;
                    this.timerDisplay = '60';
                    this.timerExpired = false;
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                    }
                },

                getWindowSpecs(sessionCode) {
                    const sw = window.screen.width;
                    const sh = window.screen.height;
                    const jw = Math.floor(sw / 3);  // judge width
                    const jh = Math.floor(sh / 2);  // judge height
                    const dw = sw;                  // display width (full)
                    const dh = Math.floor(sh / 2);  // display height

                    const baseUrl = `${window.location.origin}/?code=${sessionCode}`;

                    return {
                        leftJudge: {
                            url: `${baseUrl}&demo=left_judge`,
                            params: `width=${jw},height=${jh},left=0,top=0`
                        },
                        centerJudge: {
                            url: `${baseUrl}&demo=center_judge`,
                            params: `width=${jw},height=${jh},left=${jw},top=0`
                        },
                        rightJudge: {
                            url: `${baseUrl}&demo=right_judge`,
                            params: `width=${jw},height=${jh},left=${2*jw},top=0`
                        },
                        display: {
                            url: `${baseUrl}&demo=display`,
                            params: `width=${dw},height=${dh},left=0,top=${jh}`
                        }
                    };
                },

                async startDemo() {
                    try {
                        // Create session
                        const response = await fetch('/api/sessions', { method: 'POST' });
                        if (!response.ok) {
                            alert('Failed to create session. Please try again.');
                            return;
                        }
                        const data = await response.json();
                        const sessionCode = data.session_code;

                        // Calculate window positions
                        const specs = this.getWindowSpecs(sessionCode);

                        // Create unique window names using timestamp to ensure new windows are created
                        const timestamp = Date.now();
                        window.open(specs.leftJudge.url, `leftJudge_${timestamp}`, specs.leftJudge.params);
                        window.open(specs.centerJudge.url, `centerJudge_${timestamp}`, specs.centerJudge.params);
                        window.open(specs.rightJudge.url, `rightJudge_${timestamp}`, specs.rightJudge.params);
                        window.open(specs.display.url, `display_${timestamp}`, specs.display.params);

                        // Return to landing
                        this.screen = 'landing';
                    } catch (error) {
                        alert('Failed to start demo. Please try again.');
                        console.error('Demo mode error:', error);
                    }
                },

                init() {
                    // Check URL parameters on load
                    const urlParams = new URLSearchParams(window.location.search);
                    const demoRole = urlParams.get('demo');
                    const sessionCode = urlParams.get('code');

                    if (demoRole && sessionCode) {
                        // Skip to role selection and auto-join
                        this.sessionCode = sessionCode;
                        this.joinCode = sessionCode;
                        // Defer the join to allow Alpine to finish initialization
                        setTimeout(() => this.joinSession(demoRole), 100);
                    } else {
                        // Normal landing screen
                        this.screen = 'landing';
                    }
                }
            };
        }

        // Handle browser back button
        window.addEventListener('popstate', () => {
            const appElement = document.querySelector('[x-data]');
            if (appElement && appElement.__x_data) {
                const app = appElement.__x_data;
                if ((app.screen === 'judge' || app.screen === 'display') && app.sessionCode) {
                    app.returnToRoleSelection();
                    // Prevent default back navigation
                    history.pushState(null, null, location.href);
                }
            }
        });
    </script>
</body>
</html>
