<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Verdict — Powerlifting Judging</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        // Read demo join params from URL before Alpine loads.
        // Demo popup URLs contain ?code=&demo= so Alpine's init() can auto-join.
        // These params only ever appear in demo sessions (not real competitions),
        // so no sensitive data is exposed.
        (function () {
            var p = new URLSearchParams(window.location.search);
            var code = p.get('code');
            var demo = p.get('demo');
            window._demoParams = (code && demo) ? { code: code, demo: demo } : null;
        })();
    </script>
    <script
        defer
        src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"
        integrity="sha384-l8f0VcPi/M1iHPv8egOnY/15TDwqgbOR1anMIJWvU6nLRgZVLTLSaNqi/TOoT5Fh"
        crossorigin="anonymous">
    </script>
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
        --bg-void: #0A0A0A;
        --bg-surface: #141414;
        --bg-raised: #1E1E1E;
        --chrome-dark: #404040;
        --blood: #B91C1C;
        --blood-bright: #EF4444;
        --blood-glow: rgba(185,28,28,0.3);
        --text-chrome: #D4D4D4;
        --text-dim: #6B6B6B;
        --vote-red: #DC2626;
        --vote-blue: #2563EB;
        --vote-yellow: #EAB308;
        --success: #22C55E;
    }

    body {
        font-family: 'Rajdhani', sans-serif;
        background: var(--bg-void);
        color: var(--text-chrome);
        min-height: 100vh;
    }

    /* ===== CHROME GRADIENT TEXT ===== */
    .chrome-text {
        background: linear-gradient(180deg, #FFFFFF 0%, #C0C0C0 40%, #808080 60%, #A0A0A0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* ===== ANGULAR CUT CORNERS ===== */
    .cut-corner {
        clip-path: polygon(
            12px 0%, 100% 0%,
            100% calc(100% - 12px),
            calc(100% - 12px) 100%,
            0% 100%,
            0% 12px
        );
    }

    .cut-corner-sm {
        clip-path: polygon(
            8px 0%, 100% 0%,
            100% calc(100% - 8px),
            calc(100% - 8px) 100%,
            0% 100%,
            0% 8px
        );
    }

    /* ===== LANDING ===== */
    .landing-wrap {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        background: linear-gradient(135deg, var(--bg-void) 60%, rgba(185,28,28,0.05) 100%);
        position: relative;
    }

    .landing-wrap::before {
        content: '';
        position: absolute;
        top: 0; right: 0;
        width: 200px; height: 100%;
        background: linear-gradient(135deg, transparent 48%, rgba(185,28,28,0.03) 49%,
                    rgba(185,28,28,0.03) 51%, transparent 52%);
    }

    .landing-panel {
        width: 100%;
        max-width: 440px;
        background: var(--bg-surface);
        border: 1px solid var(--chrome-dark);
        padding: 40px 32px;
        position: relative;
    }

    .landing-panel::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--blood), var(--blood-bright), var(--blood));
    }

    .brand-iron {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 64px;
        letter-spacing: 10px;
        line-height: 1;
        text-align: center;
    }

    .brand-verdict-sub {
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        font-size: 13px;
        letter-spacing: 10px;
        text-transform: uppercase;
        color: var(--blood-bright);
        text-align: center;
        margin-top: -2px;
    }

    .chrome-input {
        width: 100%;
        padding: 14px 16px;
        font-family: 'Rajdhani', sans-serif;
        font-size: 17px;
        font-weight: 600;
        letter-spacing: 1px;
        background: var(--bg-void);
        border: 1px solid var(--chrome-dark);
        border-left: 3px solid var(--blood);
        color: var(--text-chrome);
        transition: all 0.2s;
    }

    .chrome-input::placeholder { color: var(--text-dim); }
    .chrome-input:focus {
        outline: none;
        border-color: var(--blood);
        box-shadow: 0 0 0 1px var(--blood-glow);
    }

    .btn-blood {
        width: 100%;
        padding: 16px;
        font-family: 'Bebas Neue', sans-serif;
        font-size: 20px;
        letter-spacing: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.15s;
        text-transform: uppercase;
    }

    .btn-blood:active:not(:disabled) { transform: scale(0.98); }

    .btn-blood-primary {
        background: linear-gradient(180deg, #DC2626 0%, #991B1B 100%);
        color: #fff;
        box-shadow: 0 4px 20px var(--blood-glow);
    }

    .btn-blood-primary:hover:not(:disabled) {
        box-shadow: 0 6px 30px rgba(185,28,28,0.5);
    }

    .btn-blood-secondary {
        background: var(--bg-raised);
        color: var(--text-chrome);
        border: 1px solid var(--chrome-dark);
    }

    .btn-blood-secondary:hover:not(:disabled) {
        border-color: var(--blood);
    }

    .btn-blood-ghost {
        background: transparent;
        color: var(--text-dim);
        border: 1px solid #2a2a2a;
        font-size: 16px;
        letter-spacing: 3px;
    }

    .btn-blood-ghost:hover:not(:disabled) {
        color: var(--text-chrome);
        border-color: var(--chrome-dark);
    }

    button:disabled { opacity: 0.4; cursor: not-allowed; }

    .slash-divider {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 12px 0;
        color: var(--text-dim);
        font-size: 13px;
        letter-spacing: 4px;
        text-transform: uppercase;
    }

    .slash-divider::before, .slash-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--chrome-dark), transparent);
    }

    .form-stack { display: flex; flex-direction: column; gap: 12px; margin-top: 32px; }

    /* ===== ROLE SELECTION ===== */
    .role-wrap {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        background: var(--bg-void);
    }

    .role-panel {
        width: 100%;
        max-width: 500px;
        background: var(--bg-surface);
        border: 1px solid var(--chrome-dark);
        padding: 32px;
        position: relative;
    }

    .role-panel::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--blood), var(--blood-bright), var(--blood));
    }

    .role-heading {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 32px;
        letter-spacing: 4px;
        text-align: center;
    }

    .session-tag {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 18px;
        letter-spacing: 3px;
        text-align: center;
        margin: 16px 0 24px;
        color: var(--text-dim);
    }

    .session-tag .code {
        color: var(--blood-bright);
        font-size: 22px;
        cursor: pointer;
        text-decoration: underline;
    }

    .role-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .role-btn {
        padding: 24px 8px;
        font-family: 'Bebas Neue', sans-serif;
        font-size: 18px;
        letter-spacing: 2px;
        text-align: center;
        background: var(--bg-raised);
        border: 1px solid var(--chrome-dark);
        color: var(--text-chrome);
        cursor: pointer;
        transition: all 0.2s;
        line-height: 1.3;
        width: 100%;
    }

    .role-btn:hover {
        border-color: var(--blood);
        box-shadow: inset 0 0 20px rgba(185,28,28,0.1);
    }

    .role-btn .sub {
        font-family: 'Rajdhani', sans-serif;
        font-size: 12px;
        color: var(--text-dim);
        display: block;
        margin-top: 2px;
        letter-spacing: 1px;
    }

    .role-display-btn {
        grid-column: 1 / -1;
        margin-top: 6px;
        background: linear-gradient(180deg, #DC2626 0%, #991B1B 100%);
        color: #fff;
        border-color: var(--blood);
    }

    /* ===== JUDGE SCREEN ===== */
    .judge-wrap {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 10px;
        gap: 10px;
        background: var(--bg-void);
    }

    .judge-bar {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 10px 16px;
        background: var(--bg-surface);
        border-bottom: 2px solid var(--blood);
    }

    .judge-role-label {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 18px;
        letter-spacing: 3px;
        color: var(--blood-bright);
    }

    .judge-timer {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 60px;
        color: var(--text-chrome);
        line-height: 1;
        font-variant-numeric: tabular-nums;
    }

    .judge-timer.expired {
        color: var(--vote-red);
        text-shadow: 0 0 20px var(--blood-glow);
        animation: pulse-red 1s ease infinite;
    }

    @keyframes pulse-red {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .judge-code {
        text-align: right;
        font-size: 14px;
        color: var(--text-dim);
        letter-spacing: 1px;
    }

    .judge-code .code-link {
        color: var(--blood-bright);
        cursor: pointer;
        text-decoration: underline;
    }

    .vote-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        flex: 1;
        max-height: 420px;
    }

    .vote-btn {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 32px;
        letter-spacing: 5px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.12s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 110px;
        position: relative;
        overflow: hidden;
        width: 100%;
    }

    .vote-btn::before {
        content: '';
        position: absolute;
        top: -50%; right: -50%;
        width: 100%; height: 200%;
        background: linear-gradient(135deg, transparent 48%, rgba(255,255,255,0.04) 49%, transparent 51%);
        pointer-events: none;
    }

    .vote-btn.selected {
        transform: scale(0.96);
        border-color: #fff !important;
        box-shadow: inset 0 0 30px rgba(255,255,255,0.1);
    }

    .vote-white {
        background: linear-gradient(180deg, #F0F0F0 0%, #C8C8C8 100%);
        color: #0A0A0A;
        border-color: #888;
    }

    .vote-red {
        background: linear-gradient(180deg, #EF4444 0%, #991B1B 100%);
        color: #fff;
    }

    .vote-blue {
        background: linear-gradient(180deg, #3B82F6 0%, #1E40AF 100%);
        color: #fff;
    }

    .vote-yellow {
        background: linear-gradient(180deg, #FBBF24 0%, #B45309 100%);
        color: #0A0A0A;
    }

    .lock-btn {
        width: 100%;
        padding: 20px;
        font-family: 'Bebas Neue', sans-serif;
        font-size: 26px;
        letter-spacing: 6px;
        background: linear-gradient(180deg, var(--success) 0%, #15803D 100%);
        color: #fff;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(34,197,94,0.3);
    }

    .locked-status {
        text-align: center;
        padding: 16px;
        font-family: 'Bebas Neue', sans-serif;
        font-size: 20px;
        letter-spacing: 4px;
        color: var(--success);
        border: 1px solid var(--success);
        background: rgba(34,197,94,0.05);
    }

    .head-section {
        border-top: 2px solid var(--chrome-dark);
        padding-top: 14px;
    }

    .head-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 16px;
        letter-spacing: 4px;
        color: var(--text-dim);
        margin-bottom: 10px;
    }

    .head-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .head-grid .btn-blood { font-size: 16px; padding: 12px; letter-spacing: 2px; }

    .settings-bar {
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
        margin-top: 10px;
        padding: 8px 12px;
        border: 1px solid #2a2a2a;
        background: var(--bg-surface);
    }

    .settings-bar label {
        font-size: 14px;
        color: var(--text-dim);
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
    }

    .settings-bar select {
        padding: 5px 8px;
        background: var(--bg-void);
        border: 1px solid #2a2a2a;
        color: var(--text-chrome);
        font-family: 'Rajdhani', sans-serif;
        font-size: 14px;
        font-weight: 600;
    }

    /* ===== DISPLAY SCREEN ===== */
    .display-full {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background:
            radial-gradient(circle at 50% 80%, rgba(185,28,28,0.06) 0%, transparent 50%),
            var(--bg-void);
        padding: 40px;
        gap: 36px;
        position: relative;
        overflow: hidden;
    }

    .display-full::before, .display-full::after {
        content: '';
        position: absolute;
        width: 2px;
        height: 120%;
        background: rgba(185,28,28,0.08);
        transform: rotate(15deg);
    }
    .display-full::before { left: 10%; }
    .display-full::after { right: 10%; }

    .display-tag {
        position: absolute;
        top: 16px;
        right: 20px;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        font-size: 18px;
        letter-spacing: 2px;
        color: var(--text-dim);
    }

    .display-timer-big {
        font-family: 'Bebas Neue', sans-serif;
        font-size: min(30vw, 300px);
        color: var(--text-chrome);
        line-height: 1;
        font-variant-numeric: tabular-nums;
        text-shadow: 0 0 60px rgba(255,255,255,0.03);
    }

    .display-timer-big.expired {
        color: var(--vote-red);
        text-shadow: 0 0 80px var(--blood-glow);
    }

    .display-lights {
        display: flex;
        gap: 40px;
    }

    .display-orb {
        width: min(20vw, 200px);
        height: min(20vw, 200px);
        border-radius: 50%;
        background: radial-gradient(circle at 40% 40%, #2a2a2a, #141414);
        border: 3px solid var(--chrome-dark);
        transition: all 0.3s;
        box-shadow: inset 0 4px 12px rgba(0,0,0,0.5);
    }

    .display-orb.white {
        background: radial-gradient(circle at 35% 35%, #FFFFFF, #B8B8B8);
        border-color: #999;
        box-shadow: 0 0 50px rgba(255,255,255,0.3), 0 0 100px rgba(255,255,255,0.1);
    }
    .display-orb.red {
        background: radial-gradient(circle at 35% 35%, #EF4444, #7F1D1D);
        border-color: #DC2626;
        box-shadow: 0 0 50px rgba(220,38,38,0.4), 0 0 100px rgba(220,38,38,0.15);
    }
    .display-orb.blue {
        background: radial-gradient(circle at 35% 35%, #3B82F6, #1E3A8A);
        border-color: #2563EB;
        box-shadow: 0 0 50px rgba(59,130,246,0.4), 0 0 100px rgba(59,130,246,0.15);
    }
    .display-orb.yellow {
        background: radial-gradient(circle at 35% 35%, #FBBF24, #78350F);
        border-color: #EAB308;
        box-shadow: 0 0 50px rgba(251,191,36,0.4), 0 0 100px rgba(251,191,36,0.15);
    }

    .display-status {
        font-family: 'Rajdhani', sans-serif;
        font-weight: 600;
        font-size: 22px;
        letter-spacing: 6px;
        text-transform: uppercase;
        color: var(--text-dim);
    }

    .display-verdict {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 100%;
        max-width: 800px;
    }

    .verdict-stamp {
        font-family: 'Bebas Neue', sans-serif;
        font-size: min(7vw, 60px);
        letter-spacing: 8px;
        padding: 10px 48px;
    }

    .verdict-stamp.valid {
        color: var(--success);
        border: 3px solid var(--success);
        box-shadow: 0 0 30px rgba(34,197,94,0.15);
    }

    .verdict-stamp.invalid {
        color: var(--blood-bright);
        border: 3px solid var(--blood);
        box-shadow: 0 0 30px var(--blood-glow);
    }

    .reason-card {
        width: 100%;
        overflow: hidden;
        border: 1px solid var(--chrome-dark);
    }

    .reason-card-header {
        padding: 8px 20px;
        font-family: 'Bebas Neue', sans-serif;
        font-size: min(3.5vw, 28px);
        letter-spacing: 4px;
        color: #fff;
    }

    .reason-card-header.red   { background: var(--vote-red); }
    .reason-card-header.blue  { background: var(--vote-blue); }
    .reason-card-header.yellow { background: var(--vote-yellow); color: #0A0A0A; }

    .reason-card-body {
        padding: 12px 20px 12px 44px;
        background: var(--bg-surface);
        list-style: disc;
    }

    .reason-card-body li {
        padding: 3px 0;
        font-family: 'Rajdhani', sans-serif;
        font-size: min(2.8vw, 26px);
        font-weight: 600;
        color: var(--text-chrome);
        line-height: 1.4;
    }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
        .judge-timer { font-size: 48px; }
        .vote-btn { font-size: 24px; min-height: 90px; }
        .role-grid { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>
<div x-data="judgemeApp()">

    <!-- Landing Screen -->
    <div class="landing-wrap" x-show="screen === 'landing'">
        <div class="landing-panel cut-corner">
            <div class="brand-iron chrome-text">Iron Verdict</div>
            <div class="brand-verdict-sub">Powerlifting Judging</div>

            <div class="form-stack">
                <input class="chrome-input" placeholder="Session name (e.g. Platform A)"
                       x-model="newSessionName" @keyup.enter="createSession()">
                <button class="btn-blood btn-blood-primary cut-corner-sm"
                        @click="createSession()" :disabled="!newSessionName.trim()">
                    Create New Session
                </button>

                <div class="slash-divider">or</div>

                <input class="chrome-input" placeholder="Enter 8-character session code"
                       x-model="joinCode" @keyup.enter="joinExistingSession()">
                <button class="btn-blood btn-blood-secondary cut-corner-sm"
                        @click="joinExistingSession()">
                    Join Session
                </button>
            </div>

            <div style="margin-top: 16px;">
                <button class="btn-blood btn-blood-ghost" @click="startDemo()">
                    Start Demo
                </button>
            </div>
        </div>
    </div>

    <!-- Role Selection Screen -->
    <div class="role-wrap" x-show="screen === 'role-select'">
        <div class="role-panel cut-corner">
            <div class="role-heading chrome-text">Select Role</div>
            <div class="session-tag">
                Session: <span class="code" @click="returnToLanding()" x-text="sessionCode"></span>
            </div>

            <div class="role-grid">
                <button class="role-btn cut-corner-sm" @click="joinSession('left_judge')">
                    Left<br>Judge
                </button>
                <button class="role-btn cut-corner-sm" @click="joinSession('center_judge')">
                    Center<br>Judge<span class="sub">(Head)</span>
                </button>
                <button class="role-btn cut-corner-sm" @click="joinSession('right_judge')">
                    Right<br>Judge
                </button>
                <button class="role-btn role-display-btn cut-corner-sm" @click="joinSession('display')">
                    Display Screen
                </button>
            </div>
        </div>
    </div>

    <!-- Judge Screen -->
    <div class="judge-wrap" x-show="screen === 'judge'">
        <div class="judge-bar">
            <div class="judge-role-label" x-text="getRoleDisplayName()"></div>
            <div class="judge-timer" :class="timerExpired && 'expired'" x-text="timerDisplay"></div>
            <div class="judge-code">
                <span class="code-link" @click="returnToRoleSelection()" x-text="sessionCode"></span>
            </div>
        </div>

        <div class="vote-grid" :style="voteLocked ? 'opacity:0.35;pointer-events:none' : ''">
            <button class="vote-btn vote-white cut-corner-sm"
                    :class="selectedVote === 'white' && 'selected'"
                    @click="selectVote('white')" :disabled="voteLocked">
                WHITE
            </button>
            <button class="vote-btn vote-red cut-corner-sm"
                    :class="selectedVote === 'red' && 'selected'"
                    @click="selectVote('red')" :disabled="voteLocked">
                RED
            </button>
            <button class="vote-btn vote-blue cut-corner-sm"
                    :class="selectedVote === 'blue' && 'selected'"
                    @click="selectVote('blue')" :disabled="voteLocked">
                BLUE
            </button>
            <button class="vote-btn vote-yellow cut-corner-sm"
                    :class="selectedVote === 'yellow' && 'selected'"
                    @click="selectVote('yellow')" :disabled="voteLocked">
                YELLOW
            </button>
        </div>

        <button class="lock-btn cut-corner-sm"
                x-show="selectedVote && !voteLocked"
                @click="lockVote()">
            LOCK IN
        </button>

        <div class="locked-status" x-show="voteLocked">
            &#10003; Vote Locked &#8212; <span x-text="selectedVote?.toUpperCase()"></span>
        </div>

        <div class="head-section" x-show="isHead">
            <div class="head-title">Head Judge Controls</div>
            <div class="head-grid">
                <button class="btn-blood btn-blood-primary cut-corner-sm"
                        @click="startTimer()">Start Timer</button>
                <button class="btn-blood btn-blood-secondary cut-corner-sm"
                        @click="resetTimer()">Reset Timer</button>
                <button class="btn-blood btn-blood-primary cut-corner-sm"
                        @click="nextLift()" :disabled="!resultsShown">Next Lift</button>
                <button class="btn-blood btn-blood-ghost"
                        @click="confirmEndSession()">End Session</button>
            </div>
            <div class="settings-bar">
                <label>
                    <input type="checkbox" x-model="showExplanations" @change="saveSettings()">
                    Show rule explanations
                </label>
                <select x-model="liftType" @change="saveSettings()">
                    <option value="squat">Squat</option>
                    <option value="bench">Bench Press</option>
                    <option value="deadlift">Deadlift</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Display Screen: shows sessionName only — sessionCode intentionally omitted (C3) -->
    <div class="display-full" x-show="screen === 'display'">
        <div class="display-tag">
            <span x-show="!isDemo" x-text="sessionName"></span>
            <span x-show="isDemo">DEMO</span>
        </div>

        <div class="display-timer-big" :class="timerExpired && 'expired'" x-text="timerDisplay"></div>

        <!-- Phase 1 & idle: Vote orbs -->
        <div class="display-lights" x-show="displayPhase === 'votes' || displayPhase === 'idle'">
            <div class="display-orb" :class="displayVotes.left"></div>
            <div class="display-orb" :class="displayVotes.center"></div>
            <div class="display-orb" :class="displayVotes.right"></div>
        </div>

        <!-- Phase 2: Explanation panel -->
        <div class="display-verdict" x-show="displayPhase === 'explanation'">
            <div class="verdict-stamp"
                 :class="isValidLift() ? 'valid' : 'invalid'"
                 x-text="isValidLift() ? 'Good Lift' : 'No Lift'"></div>
            <template x-for="color in getInvalidColors()" :key="color">
                <div class="reason-card">
                    <div class="reason-card-header" :class="color"
                         x-text="color.toUpperCase() + ' CARD'"></div>
                    <ul class="reason-card-body">
                        <template x-for="reason in getReasons(color)" :key="reason">
                            <li x-text="reason"></li>
                        </template>
                    </ul>
                </div>
            </template>
        </div>

        <div class="display-status" x-text="displayStatus"></div>
    </div>

</div>

    <script>
        const CARD_REASONS = {
            squat: {
                red: [
                    "Not deep enough (hip crease not below top of knees)"
                ],
                blue: [
                    "Knees not locked at start or finish",
                    "Double bounce or downward movement during ascent"
                ],
                yellow: [
                    "Foot movement (stepping forward/backward/laterally)",
                    "Didn't wait for signal (start or rack)",
                    "Elbow/upper arm contact supporting on legs",
                    "Dropped or dumped the bar after completion",
                    "Spotter/loader contact during lift",
                    "Incomplete / non-compliance with rules of performance"
                ]
            },
            bench: {
                red: [
                    "Bar not lowered to chest/abdomen (or touching belt)",
                    "Elbows not lowered level with or below shoulders"
                ],
                blue: [
                    "Downward movement during press",
                    "Arms not locked out at completion",
                    "Arms not locked before START command"
                ],
                yellow: [
                    "Heaving or sinking bar after motionless on chest",
                    "Didn't wait for signal (start, press, or rack)",
                    "Upper body thrust to initiate press off chest",
                    "Position change (head/shoulders/buttocks lifting, hands shifting)",
                    "Feet touched bench or supports",
                    "Deliberate bar contact with rack supports",
                    "Spotter/loader contact during lift",
                    "Incomplete / non-compliance with rules of performance"
                ]
            },
            deadlift: {
                red: [
                    "Knees not locked straight",
                    "Shoulders not back (deltoid not behind bar projection)"
                ],
                blue: [
                    "Downward movement before final position",
                    "Supported bar on thighs"
                ],
                yellow: [
                    "Lowered bar before 'Down' signal",
                    "Dropped bar / released from palms",
                    "Foot movement (stepping forward/backward/laterally)",
                    "Spotter/loader contact during lift",
                    "Incomplete / non-compliance with rules of performance"
                ]
            }
        };

        function judgemeApp() {
            return {
                screen: 'landing',
                sessionCode: '',
                sessionName: '',
                newSessionName: '',
                isDemo: false,
                joinCode: '',
                role: '',
                isHead: false,
                ws: null,
                selectedVote: null,
                voteLocked: false,
                resultsShown: false,
                timerDisplay: '60',
                timerExpired: false,
                timerInterval: null,
                displayVotes: { left: null, center: null, right: null },
                displayStatus: 'Waiting for judges...',
                intentionalNavigation: false,
                showExplanations: false,
                liftType: 'squat',
                displayPhase: 'idle',
                displayShowExplanations: false,
                displayLiftType: 'squat',
                _phaseTimer1: null,
                _phaseTimer2: null,

                async createSession() {
                    try {
                        const response = await fetch('/api/sessions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: this.newSessionName.trim() })
                        });
                        if (!response.ok) {
                            alert('Failed to create session. Please try again.');
                            return;
                        }
                        const data = await response.json();
                        this.sessionCode = data.session_code;
                        this.sessionName = this.newSessionName.trim();
                        this.screen = 'role-select';
                    } catch (error) {
                        alert('Error creating session. Please check your connection.');
                        console.error('Session creation error:', error);
                    }
                },

                joinExistingSession() {
                    if (this.joinCode) {
                        this.sessionCode = this.joinCode;
                        this.screen = 'role-select';
                    }
                },

                joinSession(role) {
                    this.role = role;
                    const code = this.sessionCode || this.joinCode;
                    this.sessionCode = code;

                    // Apply display mode styling
                    if (role === 'display') {
                        document.body.classList.add('display-mode');
                    }

                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

                    this.ws.onopen = () => {
                        this.ws.send(JSON.stringify({
                            type: 'join',
                            session_code: code,
                            role: role
                        }));
                    };

                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        alert('Connection error. Please check your network and try again.');
                    };

                    this.ws.onclose = (event) => {
                        if (!event.wasClean && !this.intentionalNavigation) {
                            console.error('WebSocket closed unexpectedly:', event);
                            alert('Connection lost. Please refresh and try again.');
                        }
                    };
                },

                handleMessage(message) {
                    if (message.type === 'join_success') {
                        this.isHead = message.is_head;
                        this.sessionName = message.session_state?.name || '';
                        this.screen = this.role === 'display' ? 'display' : 'judge';
                        if (this.isHead) {
                            this.saveSettings();  // sync localStorage settings to server
                        }
                        const trms = message.session_state?.time_remaining_ms;
                        if (trms > 0) {
                            this.startTimerCountdown(trms);
                        }
                    } else if (message.type === 'join_error') {
                        const sanitizedMessage = document.createTextNode(message.message).textContent;
                        alert(`Failed to join session: ${sanitizedMessage}`);
                    } else if (message.type === 'error') {
                        const sanitizedMessage = document.createTextNode(message.message).textContent;
                        alert(`Error: ${sanitizedMessage}`);
                    } else if (message.type === 'show_results') {
                        this.resultsShown = true;
                        clearInterval(this.timerInterval);
                        if (this.role === 'display') {
                            clearTimeout(this._phaseTimer1);
                            clearTimeout(this._phaseTimer2);
                            this.displayVotes = message.votes;
                            this.displayShowExplanations = message.showExplanations;
                            this.displayLiftType = message.liftType;
                            this.displayPhase = 'votes';
                            this.displayStatus = '';

                            this._phaseTimer1 = setTimeout(() => {
                                const nonWhite = Object.values(this.displayVotes).filter(c => c && c !== 'white');
                                if (this.displayShowExplanations && nonWhite.length > 0) {
                                    this.displayPhase = 'explanation';
                                    this._phaseTimer2 = setTimeout(() => { this.displayPhase = 'idle'; }, 6000);
                                } else {
                                    this.displayPhase = 'idle';
                                }
                            }, 3000);
                        }
                    } else if (message.type === 'reset_for_next_lift') {
                        clearTimeout(this._phaseTimer1);
                        clearTimeout(this._phaseTimer2);
                        this.resetVoting();
                        this.stopTimer();
                        if (this.role === 'display') {
                            this.displayVotes = { left: null, center: null, right: null };
                            this.displayPhase = 'idle';
                            this.displayStatus = 'Waiting for judges...';
                        }
                    } else if (message.type === 'timer_start') {
                        this.startTimerCountdown(message.time_remaining_ms);
                    } else if (message.type === 'timer_reset') {
                        this.stopTimer();
                    } else if (message.type === 'session_ended') {
                        alert('Session ended');
                        this.ws.close();
                        this.isDemo = false;
                        this.screen = 'landing';
                    }
                },

                selectVote(color) {
                    if (!this.voteLocked) {
                        this.selectedVote = color;
                    }
                },

                lockVote() {
                    if (this.selectedVote && !this.voteLocked) {
                        this.voteLocked = true;
                        this.ws.send(JSON.stringify({
                            type: 'vote_lock',
                            color: this.selectedVote
                        }));
                    }
                },

                saveSettings() {
                    if (!this.isHead) return;
                    localStorage.setItem('showExplanations', this.showExplanations);
                    localStorage.setItem('liftType', this.liftType);
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({
                            type: 'settings_update',
                            showExplanations: this.showExplanations,
                            liftType: this.liftType
                        }));
                    }
                },

                resetVoting() {
                    this.selectedVote = null;
                    this.voteLocked = false;
                    this.resultsShown = false;
                },

                startTimer() {
                    this.ws.send(JSON.stringify({ type: 'timer_start' }));
                },

                resetTimer() {
                    this.ws.send(JSON.stringify({ type: 'timer_reset' }));
                },

                startTimerCountdown(timeRemainingMs) {
                    this.stopTimer();
                    const startedAt = Date.now();
                    const initial = timeRemainingMs;

                    this.timerInterval = setInterval(() => {
                        const remaining = Math.max(0, initial - (Date.now() - startedAt));
                        const seconds = Math.ceil(remaining / 1000);
                        this.timerDisplay = seconds;
                        this.timerExpired = seconds === 0;

                        if (seconds === 0) {
                            clearInterval(this.timerInterval);
                        }
                    }, 100);
                },

                stopTimer() {
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                    }
                    this.timerDisplay = '60';
                    this.timerExpired = false;
                },

                nextLift() {
                    this.ws.send(JSON.stringify({ type: 'next_lift' }));
                },

                confirmEndSession() {
                    if (confirm('Are you sure? This will disconnect all judges and the display')) {
                        this.ws.send(JSON.stringify({ type: 'end_session_confirmed' }));
                    }
                },

                getRoleDisplayName() {
                    const names = {
                        'left_judge': 'Left Judge',
                        'center_judge': 'Center Judge (Head)',
                        'right_judge': 'Right Judge'
                    };
                    return names[this.role] || this.role;
                },

                isValidLift() {
                    const whiteCount = Object.values(this.displayVotes).filter(c => c === 'white').length;
                    return whiteCount >= 2;
                },

                getInvalidColors() {
                    return [...new Set(Object.values(this.displayVotes).filter(c => c && c !== 'white'))];
                },

                getReasons(color) {
                    const liftData = CARD_REASONS[this.displayLiftType];
                    return liftData ? (liftData[color] || []) : [];
                },

                returnToLanding() {
                    this.intentionalNavigation = true;
                    this.screen = 'landing';
                    this.sessionCode = '';
                    this.joinCode = '';
                    this.isDemo = false;
                    this.sessionName = '';
                    this.newSessionName = '';
                },

                returnToRoleSelection() {
                    this.intentionalNavigation = true;
                    if (this.ws) {
                        this.ws.close();
                    }
                    document.body.classList.remove('display-mode');
                    this.screen = 'role-select';
                    this.selectedVote = null;
                    this.voteLocked = false;
                    this.resultsShown = false;
                    this.timerDisplay = '60';
                    this.timerExpired = false;
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                    }
                },

                getWindowSpecs(sessionCode) {
                    const sw = window.screen.width;
                    const sh = window.screen.height;
                    const jw = Math.floor(sw / 3);  // judge width
                    const jh = Math.floor(sh / 2);  // judge height
                    const dw = sw;                  // display width (full)
                    const dh = Math.floor(sh / 2);  // display height
                    // screen.availLeft/availTop give this screen's origin in the virtual
                    // desktop coordinate space (non-zero on secondary/tertiary monitors).
                    const sl = window.screen.availLeft ?? 0;
                    const st = window.screen.availTop ?? 0;

                    const baseUrl = `${window.location.origin}/?code=${sessionCode}`;

                    return {
                        leftJudge:   { url: `${baseUrl}&demo=left_judge`,   params: `width=${jw},height=${jh},left=${sl},top=${st}` },
                        centerJudge: { url: `${baseUrl}&demo=center_judge`, params: `width=${jw},height=${jh},left=${sl+jw},top=${st}` },
                        rightJudge:  { url: `${baseUrl}&demo=right_judge`,  params: `width=${jw},height=${jh},left=${sl+2*jw},top=${st}` },
                        display:     { url: `${baseUrl}&demo=display`,      params: `width=${dw},height=${dh},left=${sl},top=${st+jh}` }
                    };
                },

                async startDemo() {
                    try {
                        // Create session
                        const response = await fetch('/api/sessions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: 'Demo' })
                        });
                        if (!response.ok) {
                            alert('Failed to create session. Please try again.');
                            return;
                        }
                        const data = await response.json();
                        const sessionCode = data.session_code;

                        // Open each demo window with its role encoded in the URL.
                        // These are demo-only sessions, so the code in the URL is acceptable.
                        const specs = this.getWindowSpecs(sessionCode);
                        const timestamp = Date.now();
                        window.open(specs.leftJudge.url,   `leftJudge_${timestamp}`,   specs.leftJudge.params);
                        window.open(specs.centerJudge.url, `centerJudge_${timestamp}`, specs.centerJudge.params);
                        window.open(specs.rightJudge.url,  `rightJudge_${timestamp}`,  specs.rightJudge.params);
                        window.open(specs.display.url,     `display_${timestamp}`,     specs.display.params);

                        // Return to landing
                        this.isDemo = false;
                        this.screen = 'landing';
                    } catch (error) {
                        alert('Failed to start demo. Please try again.');
                        console.error('Demo mode error:', error);
                    }
                },

                init() {
                    this.showExplanations = localStorage.getItem('showExplanations') === 'true';
                    this.liftType = localStorage.getItem('liftType') || 'squat';

                    // Check for demo join params set by the inline script (see <head>).
                    const params = window._demoParams;
                    if (params) {
                        window._demoParams = null;
                        this.sessionCode = params.code;
                        this.joinCode = params.code;
                        this.isDemo = true;
                        // Defer the join to allow Alpine to finish initialization
                        setTimeout(() => this.joinSession(params.demo), 100);
                    } else {
                        // Normal landing screen
                        this.screen = 'landing';
                    }
                }
            };
        }

        // Handle browser back button
        window.addEventListener('popstate', () => {
            const appElement = document.querySelector('[x-data]');
            if (appElement && appElement.__x_data) {
                const app = appElement.__x_data;
                if ((app.screen === 'judge' || app.screen === 'display') && app.sessionCode) {
                    app.returnToRoleSelection();
                    // Prevent default back navigation
                    history.pushState(null, null, location.href);
                }
            }
        });
    </script>
</body>
</html>