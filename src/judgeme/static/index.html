<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JudgeMe - Powerlifting Judging</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
:root {
  /* Colors - Neutrals */
  --bg-primary: #F9FAFB;
  --bg-secondary: #FFFFFF;
  --text-primary: #1F2937;
  --text-secondary: #6B7280;
  --border-color: #E5E7EB;

  /* Colors - Vote Colors (IPF Standard) */
  --vote-white: #FFFFFF;
  --vote-red: #EF4444;
  --vote-blue: #3B82F6;
  --vote-yellow: #FBBF24;

  /* Colors - Functional */
  --success-color: #10B981;
  --disabled-color: #9CA3AF;
  --timer-expired: #EF4444;

  /* Typography */
  --font-family: system-ui, -apple-system, sans-serif;
  --font-size-base: 16px;
  --font-size-sm: 14px;
  --font-size-lg: 20px;
  --font-size-xl: 32px;
  --font-size-2xl: 48px;
  --font-size-timer-display: 120px;
  --font-size-timer-judge: 32px;

  --font-weight-normal: 400;
  --font-weight-bold: 700;

  /* Spacing */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-base: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;

  /* Layout */
  --touch-target-min: 48px;
  --border-radius: 4px;
  --transition-duration: 150ms;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden; /* Prevent scrolling */
}

body {
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  color: var(--text-primary);
  background-color: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Main Container & Screen Layout */
.app-container {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  overflow: hidden;
}

.screen {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  padding: var(--spacing-base);
  overflow: hidden;
}

/* Landing & Role Selection Screens - Center Content */
.screen.centered {
  align-items: center;
  justify-content: center;
  text-align: center;
}

/* Judge Screen - Vertical Stack */
.screen.judge {
  justify-content: flex-start;
}

/* Display Screen - Center Content */
.screen.display {
  align-items: center;
  justify-content: center;
}

/* Ensure no scrollbars appear */
::-webkit-scrollbar {
  display: none;
}
html, body {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Demo Mode: 4 screens on 1 display */
/* Default: 3 judges on top (1/3 width each), display full-width below */
@media (min-width: 1200px) {
  /* When judge windows are shown side-by-side in demo mode */
  .screen.judge:nth-child(1),
  .screen.judge:nth-child(2),
  .screen.judge:nth-child(3) {
    width: calc(100% / 3);
    height: 50vh;
    padding: 8px;
  }

  .screen.display {
    width: 100%;
    height: 50vh;
    padding: 8px;
  }
}

/* Button Base Styles */
button {
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-bold);
  padding: var(--spacing-sm) var(--spacing-base);
  min-height: var(--touch-target-min);
  border: 2px solid transparent;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: all var(--transition-duration) ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Primary Action Button */
.btn-primary {
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  border-color: var(--border-color);
}

.btn-primary:hover:not(:disabled) {
  background-color: var(--border-color);
  border-color: var(--text-primary);
}

.btn-primary:active:not(:disabled) {
  background-color: var(--text-primary);
  color: var(--bg-secondary);
}

/* Secondary/Muted Button */
.btn-secondary {
  background-color: transparent;
  color: var(--text-secondary);
  border-color: var(--border-color);
  font-size: var(--font-size-sm);
}

.btn-secondary:hover:not(:disabled) {
  color: var(--text-primary);
  border-color: var(--text-primary);
}

/* Disabled State */
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Voting Buttons - Large, Color-Coded */
.voting-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-base);
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

.btn-vote {
  min-height: 80px;
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-bold);
  border: 3px solid transparent;
  border-radius: var(--border-radius);
  transition: all var(--transition-duration) ease;
}

.btn-vote-white {
  background-color: var(--vote-white);
  color: var(--text-primary);
  border: 3px solid var(--text-primary);
}

.btn-vote-white:not(:disabled):hover {
  opacity: 0.8;
  box-shadow: inset 0 0 0 3px var(--text-primary);
}

.btn-vote-white.selected {
  border-color: var(--text-primary);
  box-shadow: 0 0 0 4px var(--text-primary);
}

.btn-vote-red {
  background-color: var(--vote-red);
  color: white;
  border: 3px solid var(--vote-red);
}

.btn-vote-red:not(:disabled):hover {
  opacity: 0.9;
  box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.2);
}

.btn-vote-red.selected {
  box-shadow: 0 0 0 4px var(--vote-red);
}

.btn-vote-blue {
  background-color: var(--vote-blue);
  color: white;
  border: 3px solid var(--vote-blue);
}

.btn-vote-blue:not(:disabled):hover {
  opacity: 0.9;
  box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.2);
}

.btn-vote-blue.selected {
  box-shadow: 0 0 0 4px var(--vote-blue);
}

.btn-vote-yellow {
  background-color: var(--vote-yellow);
  color: var(--text-primary);
  border: 3px solid var(--text-primary);
}

.btn-vote-yellow:not(:disabled):hover {
  opacity: 0.9;
  box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.2);
}

.btn-vote-yellow.selected {
  box-shadow: 0 0 0 4px var(--text-primary);
}

.btn-vote:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.btn-full-width {
  width: 100%;
  padding: var(--spacing-base) var(--spacing-lg);
  min-height: 56px;
  font-size: var(--font-size-lg);
}

.btn-full-width.lock-in {
  background-color: var(--success-color);
  color: white;
  font-weight: var(--font-weight-bold);
}

.btn-full-width.lock-in:hover:not(:disabled) {
  background-color: #059669;
}

/* TASK 4: Input & Card Component Styles */

/* Input Fields */
input[type="text"] {
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  padding: var(--spacing-sm) var(--spacing-base);
  min-height: var(--touch-target-min);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius);
  background-color: var(--bg-secondary);
  color: var(--text-primary);
  transition: border-color var(--transition-duration) ease;
}

input[type="text"]::placeholder {
  color: var(--text-secondary);
}

input[type="text"]:focus {
  outline: none;
  border-color: var(--text-primary);
  box-shadow: 0 0 0 3px rgba(31, 41, 55, 0.1);
}

/* Cards & Panels */
.card {
  background-color: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: var(--spacing-base);
}

.card.status-locked {
  background-color: #D1FAE5;
  border-color: var(--success-color);
  color: var(--text-primary);
  text-align: center;
  padding: var(--spacing-lg);
  font-weight: var(--font-weight-bold);
}

/* Top Bar / Header Card */
.header-bar {
  background-color: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  padding: var(--spacing-base);
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 60px;
  width: 100%;
}

.header-bar-item {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.header-bar-item.center {
  align-items: center;
  flex: 1;
}

.header-bar-item.right {
  align-items: flex-end;
}

.session-code {
  font-family: monospace;
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  cursor: pointer;
  text-decoration: underline;
  transition: color var(--transition-duration) ease;
}

.session-code:hover {
  color: var(--text-primary);
}

/* TASK 5: Landing Page Styles */

/* Landing Page */
.screen.landing {
  padding: var(--spacing-lg);
}

.landing-content {
  max-width: 500px;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
  align-items: center;
  text-align: center;
}

.landing-logo {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  margin-bottom: var(--spacing-base);
}

.landing-tagline {
  font-size: var(--font-size-lg);
  color: var(--text-secondary);
  margin-bottom: var(--spacing-lg);
}

.landing-actions {
  display: flex;
  gap: var(--spacing-base);
  width: 100%;
  flex-wrap: wrap;
  justify-content: center;
}

.landing-actions .btn-primary {
  flex: 1;
  min-width: 150px;
}

.landing-join {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.landing-join input {
  width: 100%;
}

.landing-demo {
  margin-top: var(--spacing-base);
  width: 100%;
}

/* Mobile: Stack buttons vertically */
@media (max-width: 600px) {
  .landing-actions {
    flex-direction: column;
  }

  .landing-actions .btn-primary {
    width: 100%;
  }
}

/* TASK 6: Role Selection Page Styles */

/* Role Selection Page */
.screen.role-select {
  padding: var(--spacing-lg);
  gap: var(--spacing-lg);
}

.role-select-content {
  max-width: 600px;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
  align-items: center;
}

.role-select-header {
  text-align: center;
}

.role-select-header h2 {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--spacing-base);
}

.session-display {
  font-size: var(--font-size-base);
  color: var(--text-secondary);
}

.role-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: var(--spacing-base);
  width: 100%;
  margin-bottom: var(--spacing-lg);
}

.role-buttons .btn-primary {
  width: 100%;
  min-height: 80px;
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-bold);
}

.role-buttons-display {
  display: flex;
  width: 100%;
  gap: var(--spacing-base);
}

.role-buttons-display .btn-primary {
  flex: 1;
  min-height: 80px;
  font-size: var(--font-size-lg);
}

/* Mobile: Stack judge buttons */
@media (max-width: 800px) {
  .role-buttons {
    grid-template-columns: 1fr;
  }
}

/* TASK 7: Judge Screen Styles */

/* Judge Screen */
.screen.judge {
  padding: 0;
  gap: 0;
}

.judge-header {
  flex-shrink: 0;
  background-color: var(--bg-secondary);
  border-bottom: 2px solid var(--border-color);
  padding: var(--spacing-base);
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 70px;
}

.judge-header-left {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.judge-position {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  font-weight: var(--font-weight-bold);
}

.judge-header-center {
  flex: 1;
  text-align: center;
}

.judge-header-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: var(--spacing-xs);
}

.judge-timer {
  font-size: var(--font-size-timer-judge);
  font-weight: var(--font-weight-bold);
  font-family: monospace;
  color: var(--text-primary);
  transition: color var(--transition-duration) ease;
}

.judge-timer.expired {
  color: var(--timer-expired);
}

.judge-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-lg);
  gap: var(--spacing-lg);
  overflow: hidden;
  min-height: 0;
}

.judge-voting-area {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
  width: 100%;
  max-width: 400px;
}

.judge-controls {
  flex-shrink: 0;
  border-top: 2px solid var(--border-color);
  padding: var(--spacing-lg) var(--spacing-base);
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-base);
}

.judge-controls h3 {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--spacing-sm);
}

.judge-controls-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--spacing-sm);
  width: 100%;
}

.judge-controls-buttons .btn-primary {
  width: 100%;
  min-height: 56px;
  font-size: var(--font-size-sm);
}

/* TASK 8: Display Screen Styles */

/* Display Screen */
.screen.display {
  padding: var(--spacing-lg);
  gap: var(--spacing-lg);
}

.display-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xl);
  width: 100%;
  height: 100%;
}

.display-timer {
  font-size: var(--font-size-timer-display);
  font-weight: var(--font-weight-bold);
  font-family: monospace;
  color: var(--text-primary);
  transition: color var(--transition-duration) ease;
  line-height: 1;
}

.display-timer.expired {
  color: var(--timer-expired);
}

.display-lights {
  display: flex;
  justify-content: center;
  gap: var(--spacing-xl);
  width: 100%;
}

.light {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 3px solid var(--border-color);
  background-color: #F3F4F6;
  transition: all var(--transition-duration) ease;
  flex-shrink: 0;
}

.light.voted-white {
  background-color: var(--vote-white);
  border-color: var(--text-primary);
}

.light.voted-red {
  background-color: var(--vote-red);
  border-color: var(--vote-red);
  box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
}

.light.voted-blue {
  background-color: var(--vote-blue);
  border-color: var(--vote-blue);
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
}

.light.voted-yellow {
  background-color: var(--vote-yellow);
  border-color: var(--text-primary);
  box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
}

.display-status {
  font-size: var(--font-size-lg);
  color: var(--text-secondary);
  text-align: center;
  font-weight: var(--font-weight-bold);
}

/* Large screens: bigger lights */
@media (min-width: 1200px) {
  .light {
    width: 150px;
    height: 150px;
  }

  .display-timer {
    font-size: 150px;
  }
}

/* Very large screens: even bigger */
@media (min-width: 1920px) {
  .light {
    width: 180px;
    height: 180px;
  }

  .display-timer {
    font-size: 180px;
  }
}
    </style>
</head>
<body>
    <div class="container" x-data="judgemeApp()" x-init="init()">
        <h1>JudgeMe</h1>

        <!-- Landing screen -->
        <div x-show="screen === 'landing'">
            <h2>Welcome</h2>
            <button @click="createSession()">Create New Session</button>
            <button @click="startDemo()" style="background: #17a2b8; color: white;">Start Demo</button>
            <p>or</p>
            <input type="text" x-model="joinCode" placeholder="Enter session code">
            <button @click="screen = 'role-select'">Join Session</button>
        </div>

        <!-- Role selection screen -->
        <div x-show="screen === 'role-select'">
            <h2>Select Your Role</h2>
            <p>Session: <span x-text="sessionCode"></span></p>
            <button @click="joinSession('left_judge')">Left Judge</button>
            <button @click="joinSession('center_judge')">Center Judge (Head)</button>
            <button @click="joinSession('right_judge')">Right Judge</button>
            <button @click="joinSession('display')">Display</button>
        </div>

        <!-- Judge screen -->
        <div x-show="screen === 'judge'">
            <div style="background: #f5f5f5; padding: 10px; margin-bottom: 20px;">
                <strong>Session:</strong> <span x-text="sessionCode" @click="returnToRoleSelection()" @keydown.enter="returnToRoleSelection()" tabindex="0" role="button" style="cursor: pointer; text-decoration: underline;"></span> |
                <strong>Timer:</strong> <span x-text="timerDisplay" :style="timerExpired ? 'color: red;' : ''"></span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button
                    @click="selectVote('white')"
                    :disabled="voteLocked"
                    :style="selectedVote === 'white' ? 'background: white; border: 3px solid black;' : 'background: #f0f0f0;'">
                    White
                </button>
                <button
                    @click="selectVote('red')"
                    :disabled="voteLocked"
                    :style="selectedVote === 'red' ? 'background: #ff4444; color: white; border: 3px solid black;' : 'background: #ffcccc;'">
                    Red
                </button>
                <button
                    @click="selectVote('blue')"
                    :disabled="voteLocked"
                    :style="selectedVote === 'blue' ? 'background: #4444ff; color: white; border: 3px solid black;' : 'background: #ccccff;'">
                    Blue
                </button>
                <button
                    @click="selectVote('yellow')"
                    :disabled="voteLocked"
                    :style="selectedVote === 'yellow' ? 'background: #ffff44; border: 3px solid black;' : 'background: #ffffcc;'">
                    Yellow
                </button>
            </div>

            <button
                x-show="selectedVote && !voteLocked"
                @click="lockVote()"
                style="background: #28a745; color: white; width: 100%;">
                Lock In
            </button>

            <div x-show="voteLocked" style="margin-top: 20px; padding: 10px; background: #d4edda; border-radius: 4px;">
                Your vote: <strong x-text="selectedVote"></strong> (locked)
            </div>

            <!-- Head judge controls -->
            <div x-show="isHead" style="margin-top: 30px; border-top: 2px solid #ccc; padding-top: 20px;">
                <h3>Head Judge Controls</h3>
                <button @click="startTimer()" style="background: #007bff; color: white;">Start Timer</button>
                <button @click="resetTimer()" style="background: #6c757d; color: white;">Reset Timer</button>
                <button @click="nextLift()" :disabled="!resultsShown" style="background: #ffc107;">Next Lift</button>
                <button @click="confirmEndSession()" style="background: #dc3545; color: white;">End Session</button>
            </div>
        </div>

        <!-- Display screen -->
        <div x-show="screen === 'display'">
            <div style="padding: 10px; text-align: center; background: #f5f5f5; margin-bottom: 10px;">
                <strong>Session:</strong> <span x-text="sessionCode" @click="returnToRoleSelection()" @keydown.enter="returnToRoleSelection()" tabindex="0" role="button" style="cursor: pointer; text-decoration: underline;"></span>
            </div>
            <div style="text-align: center; padding: 40px;">
                <h1 style="font-size: 48px; margin-bottom: 40px;"
                    :style="timerExpired ? 'color: red;' : ''"
                    x-text="timerDisplay">
                    60
                </h1>

                <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 40px;">
                    <!-- Left Judge -->
                    <div :style="`width: 120px; height: 120px; border-radius: 50%; border: 3px solid #ccc; background: ${displayVotes.left ? getVoteColor(displayVotes.left) : '#f0f0f0'};`">
                    </div>

                    <!-- Center Judge -->
                    <div :style="`width: 120px; height: 120px; border-radius: 50%; border: 3px solid #ccc; background: ${displayVotes.center ? getVoteColor(displayVotes.center) : '#f0f0f0'};`">
                    </div>

                    <!-- Right Judge -->
                    <div :style="`width: 120px; height: 120px; border-radius: 50%; border: 3px solid #ccc; background: ${displayVotes.right ? getVoteColor(displayVotes.right) : '#f0f0f0'};`">
                    </div>
                </div>

                <p style="font-size: 18px; color: #666;" x-text="displayStatus">Waiting for judges...</p>
            </div>
        </div>
    </div>

    <script>
        function judgemeApp() {
            return {
                screen: 'landing',
                sessionCode: '',
                joinCode: '',
                role: '',
                isHead: false,
                ws: null,
                selectedVote: null,
                voteLocked: false,
                resultsShown: false,
                timerDisplay: '60',
                timerExpired: false,
                timerInterval: null,
                displayVotes: { left: null, center: null, right: null },
                displayStatus: 'Waiting for judges...',
                intentionalNavigation: false,

                async createSession() {
                    try {
                        const response = await fetch('/api/sessions', { method: 'POST' });
                        if (!response.ok) {
                            alert('Failed to create session. Please try again.');
                            return;
                        }
                        const data = await response.json();
                        this.sessionCode = data.session_code;
                        this.screen = 'role-select';
                    } catch (error) {
                        alert('Error creating session. Please check your connection.');
                        console.error('Session creation error:', error);
                    }
                },

                joinSession(role) {
                    this.role = role;
                    const code = this.sessionCode || this.joinCode;
                    this.sessionCode = code;

                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

                    this.ws.onopen = () => {
                        this.ws.send(JSON.stringify({
                            type: 'join',
                            session_code: code,
                            role: role
                        }));
                    };

                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        alert('Connection error. Please check your network and try again.');
                    };

                    this.ws.onclose = (event) => {
                        if (!event.wasClean && !this.intentionalNavigation) {
                            console.error('WebSocket closed unexpectedly:', event);
                            alert('Connection lost. Please refresh and try again.');
                        }
                    };
                },

                handleMessage(message) {
                    if (message.type === 'join_success') {
                        this.isHead = message.is_head;
                        this.screen = this.role === 'display' ? 'display' : 'judge';
                    } else if (message.type === 'join_error') {
                        const sanitizedMessage = document.createTextNode(message.message).textContent;
                        alert(`Failed to join session: ${sanitizedMessage}`);
                    } else if (message.type === 'error') {
                        const sanitizedMessage = document.createTextNode(message.message).textContent;
                        alert(`Error: ${sanitizedMessage}`);
                    } else if (message.type === 'show_results') {
                        this.resultsShown = true;
                        if (this.role === 'display') {
                            this.displayVotes = message.votes;
                            this.displayStatus = 'Results shown';
                        }
                    } else if (message.type === 'reset_for_next_lift') {
                        this.resetVoting();
                        this.stopTimer();
                        if (this.role === 'display') {
                            this.displayVotes = { left: null, center: null, right: null };
                            this.displayStatus = 'Waiting for judges...';
                        }
                    } else if (message.type === 'timer_start') {
                        this.startTimerCountdown(message.server_timestamp);
                    } else if (message.type === 'timer_reset') {
                        this.stopTimer();
                    } else if (message.type === 'session_ended') {
                        alert('Session ended');
                        this.ws.close();
                        this.screen = 'landing';
                    }
                },

                selectVote(color) {
                    if (!this.voteLocked) {
                        this.selectedVote = color;
                    }
                },

                lockVote() {
                    if (this.selectedVote && !this.voteLocked) {
                        this.voteLocked = true;
                        this.ws.send(JSON.stringify({
                            type: 'vote_lock',
                            color: this.selectedVote
                        }));
                    }
                },

                resetVoting() {
                    this.selectedVote = null;
                    this.voteLocked = false;
                    this.resultsShown = false;
                },

                startTimer() {
                    this.ws.send(JSON.stringify({ type: 'timer_start' }));
                },

                resetTimer() {
                    this.ws.send(JSON.stringify({ type: 'timer_reset' }));
                },

                startTimerCountdown(serverTimestamp) {
                    this.stopTimer();
                    const startTime = serverTimestamp * 1000;
                    const duration = 60000; // 60 seconds

                    this.timerInterval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        const remaining = Math.max(0, duration - elapsed);
                        const seconds = Math.ceil(remaining / 1000);
                        this.timerDisplay = seconds;
                        this.timerExpired = seconds === 0;

                        if (seconds === 0) {
                            clearInterval(this.timerInterval);
                        }
                    }, 100);
                },

                stopTimer() {
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                    }
                    this.timerDisplay = '60';
                    this.timerExpired = false;
                },

                nextLift() {
                    this.ws.send(JSON.stringify({ type: 'next_lift' }));
                },

                confirmEndSession() {
                    if (confirm('Are you sure? This will disconnect all judges and the display')) {
                        this.ws.send(JSON.stringify({ type: 'end_session_confirmed' }));
                    }
                },

                getVoteColor(vote) {
                    const colors = {
                        white: 'white',
                        red: '#ff4444',
                        blue: '#4444ff',
                        yellow: '#ffff44'
                    };
                    return colors[vote] || '#f0f0f0';
                },

                returnToRoleSelection() {
                    this.intentionalNavigation = true;
                    if (this.ws) {
                        this.ws.close();
                    }
                    this.screen = 'role-select';
                    this.selectedVote = null;
                    this.voteLocked = false;
                    this.resultsShown = false;
                    this.timerDisplay = '60';
                    this.timerExpired = false;
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                    }
                },

                getWindowSpecs(sessionCode) {
                    const sw = window.screen.width;
                    const sh = window.screen.height;
                    const jw = Math.floor(sw / 3);  // judge width
                    const jh = Math.floor(sh / 2);  // judge height
                    const dw = sw;                  // display width (full)
                    const dh = Math.floor(sh / 2);  // display height

                    const baseUrl = `${window.location.origin}/?code=${sessionCode}`;

                    return {
                        leftJudge: {
                            url: `${baseUrl}&demo=left_judge`,
                            params: `width=${jw},height=${jh},left=0,top=0`
                        },
                        centerJudge: {
                            url: `${baseUrl}&demo=center_judge`,
                            params: `width=${jw},height=${jh},left=${jw},top=0`
                        },
                        rightJudge: {
                            url: `${baseUrl}&demo=right_judge`,
                            params: `width=${jw},height=${jh},left=${2*jw},top=0`
                        },
                        display: {
                            url: `${baseUrl}&demo=display`,
                            params: `width=${dw},height=${dh},left=0,top=${jh}`
                        }
                    };
                },

                async startDemo() {
                    try {
                        // Create session
                        const response = await fetch('/api/sessions', { method: 'POST' });
                        if (!response.ok) {
                            alert('Failed to create session. Please try again.');
                            return;
                        }
                        const data = await response.json();
                        const sessionCode = data.session_code;

                        // Calculate window positions
                        const specs = this.getWindowSpecs(sessionCode);

                        // Create unique window names using timestamp to ensure new windows are created
                        const timestamp = Date.now();
                        window.open(specs.leftJudge.url, `leftJudge_${timestamp}`, specs.leftJudge.params);
                        window.open(specs.centerJudge.url, `centerJudge_${timestamp}`, specs.centerJudge.params);
                        window.open(specs.rightJudge.url, `rightJudge_${timestamp}`, specs.rightJudge.params);
                        window.open(specs.display.url, `display_${timestamp}`, specs.display.params);

                        // Return to landing
                        this.screen = 'landing';
                    } catch (error) {
                        alert('Failed to start demo. Please try again.');
                        console.error('Demo mode error:', error);
                    }
                },

                init() {
                    // Check URL parameters on load
                    const urlParams = new URLSearchParams(window.location.search);
                    const demoRole = urlParams.get('demo');
                    const sessionCode = urlParams.get('code');

                    if (demoRole && sessionCode) {
                        // Skip to role selection and auto-join
                        this.sessionCode = sessionCode;
                        this.joinCode = sessionCode;
                        // Defer the join to allow Alpine to finish initialization
                        setTimeout(() => this.joinSession(demoRole), 100);
                    } else {
                        // Normal landing screen
                        this.screen = 'landing';
                    }
                }
            };
        }

        // Handle browser back button
        window.addEventListener('popstate', () => {
            const appElement = document.querySelector('[x-data]');
            if (appElement && appElement.__x_data) {
                const app = appElement.__x_data;
                if ((app.screen === 'judge' || app.screen === 'display') && app.sessionCode) {
                    app.returnToRoleSelection();
                    // Prevent default back navigation
                    history.pushState(null, null, location.href);
                }
            }
        });
    </script>
</body>
</html>
